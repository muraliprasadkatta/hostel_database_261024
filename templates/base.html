{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Document{% endblock %}</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="OOYE - Hostel management made easy. Manage tenants, payments, and property details all in one platform.">
  <meta name="keywords" content="OOYE, Hostel Management, Tenant Management, Hostel Database, Property Management">
  <meta name="author" content="Katta Muraliprasad">
  <meta property="og:title" content="OOYE – Hostel Management System" />
  <meta property="og:description" content="Efficient hostel management system to manage tenants, payments, and property details." />
  <meta property="og:url" content="https://ooye.in" />
  <meta property="og:type" content="website" />
  
    
  <!-- CSS links -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  {% include 'includes/cdnlines.html' %}
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- for (manifest.json)  -->
  <link rel="manifest" href="{% static 'manifest.json' %}">

</head>

<body>
  <!-- Sidebar for properties -->
  <div class="sidebar" id="sidebar">
    <span class="close-btn" onclick="toggleSidebar()">×</span>
    
    <!-- Profile Section -->
    <a href="{% url 'propertyProfile' selected_property.id %}">
      <div class="profile-section">
          <div class="profile-image-container">
              {% if selected_property.image_url %}
                  <img src="{{ selected_property.image_url }}" class="profile-image" id="selectedPropertyImage" alt="Property Image">
              {% else %}
                  <img src="{% static 'images/displaybeds/image-icon-placeholder.png' %}" class="profile-image" id="selectedPropertyImage" alt="Default Image">
              {% endif %}
          </div>
          <span class="profile-name" id="selectedPropertyName">{{ selected_property.hostelname }}</span>
      </div>
  </a>
  
    <!-- Properties List -->
    <ul class="sidebar-options">
      <li class="property-header">
        <i class="fas fa-exchange-alt icon"></i> Switch Properties
      </li>
      
      <li class="properties-box">
        <div class="scrollable-properties">
          {% if user_properties %}
            {% for property in user_properties %}
              <div class="property-item {% if property.id == selected_property.id %}active{% else %}disabled{% endif %}" id="property-{{ property.id }}">
                {% if property.image_url %}
                <img src="{{ property.image_url }}" class="property-image" alt="{{ property.hostelname }} Image">
            {% else %}
                <img src="{% static 'images/displaybeds/image-icon-placeholder.png' %}" class="property-image" alt="Default Image">
            {% endif %}
            
                <span class="property-name">{{ property.hostelname }}</span>
                {% if property.id == selected_property.id %}
                  <img src="{% static 'images/displayroom_sidebar/3d-tick-image.png' %}" alt="Selected" class="tick-image" id="tick-{{ property.id }}">
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div>No Properties Yet</div>
          {% endif %}
        </div>
      </li>

    <!-- Base template lo -->
    <div class="change-property-button">
      {% if show_change_property_button %}
          <button onclick="switchProperty()">Change Property</button>
      {% endif %}
    </div>

      
      <li><a href="{% url 'history_url' property_id=selected_property.id %}"><i class="fas fa-history icon"></i> History</a></li>
      <li><a href="#"><i class="fas fa-question-circle icon"></i> Help</a></li>
      <li><a href="#"><i class="fas fa-cog icon"></i> Settings</a></li>
      <li><a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt icon"></i> Logout</a></li>
    </ul>

        <!-- <button id="installButton" style="display: none;">Install App</button> -->
        <a href="#" id="installLink" style="display: none;">Install App</a>


    <div class="bottom-link">
      <a href="#"><i class="fas fa-home icon"></i> Go to Home Page</a>
    </div>
  </div>

  <!-- Header Section -->
  <div class="header" id="header">
    <div class="dispalyMenubar-icon" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </div>

    <!-- Search Section -->
     
    <!-- <div class="search-container header-search">
      <input type="text" placeholder="Search..." class="search-box" id="search-header">
      <i class="fa fa-search search-icon header-icon"></i>
    </div> -->


    <div class="search-container header-search">
      <input
          type="text"
          placeholder="Search by Name..."
          class="search-box"
          id="search-header"
          autocomplete="off"
          data-property-id="{{ selected_property.id }}"
      />
      <i class="fa fa-search search-icon header-icon"></i>
      <div class="search-dropdown" id="search-results"></div>
    </div>
  
  

    <!-- Dropdown and Navigation -->
    <div class="rightOption-icon">
      <i class="fas fa-ellipsis-v options-icon" onclick="toggleOptions()"></i>
    </div>

    <nav class="nav">
      <ul class="nav-list">
        <li><a href="#" class="nav-item nav-home">Home</a></li>
        <li><a href="#" class="nav-item nav-rooms">Rooms</a></li>
        <li><a href="{% url 'test' %}" class="nav-item nav-bookings">Bookings</a></li>
        <li><a href="{% url 'Payments' property_id=selected_property.id %}" class="nav-item nav-collections">Collections</a></li>
      </ul>
    </nav>

    <div class="dropdown-menu" id="dropdownMenu">
      <ul>
        <li><a href="#" class="nav-item" id="editRoom"><img src="{% static 'images/displayroom_header/edit_room_image.png' %}" alt="Edit Rooms" style="width:30px;height:30px;"> Edit Rooms</a></li>
        <li><a href="#" class="nav-item"><i class="fas fa-calendar-check"></i> Apply Monthly Extras</a></li>
      </ul>
    </div>
  </div>

  <!-- Content and Payment Template -->
  {% include 'data/add_property_modal.html' %}
  {% block paymentTemplate %}{% endblock %}
  {% block content %}{% endblock %}

<!-- for search box in all template  -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchBox = document.getElementById('search-header');
    const searchResults = document.getElementById('search-results');
    const propertyId = searchBox.getAttribute('data-property-id'); // Get the property ID from the input attribute
    let currentIndex = -1; // To handle arrow navigation
    let lastEnteredValue = ''; // Track the last manually entered value

    // Handle input in the search box
    searchBox.addEventListener('input', function () {
      const query = searchBox.value.trim();
      lastEnteredValue = query; // Store the manually entered value

      if (query.length > 0) {
        fetch(`/search-suggestions/?q=${encodeURIComponent(query)}&property_id=${propertyId}`)
          .then((response) => response.json())
          .then((data) => {
            searchResults.innerHTML = ''; // Clear previous results
            searchResults.style.display = 'block'; // Show dropdown
            currentIndex = -1; // Reset current index

            if (data.results && data.results.length > 0) {
              data.results.forEach((item, index) => {
                const suggestion = document.createElement('div');
                suggestion.textContent = item.name; // Display name from the API
                suggestion.classList.add('suggestion-item'); // Add class for styling
                suggestion.setAttribute('data-index', index); // Set index for navigation
                suggestion.addEventListener('mouseenter', function () {
                  highlightItem(searchResults.querySelectorAll('.suggestion-item'), index);
                });
                suggestion.addEventListener('mouseleave', function () {
                  searchBox.value = lastEnteredValue; // Reset to the last entered value on mouse leave
                });
                suggestion.addEventListener('click', function () {
                  searchBox.value = item.name; // Fill input with selected suggestion
                  searchResults.style.display = 'none'; // Hide dropdown
                  // Redirect or handle selected item
                  window.location.href = `/details/${item.id}`;
                });
                searchResults.appendChild(suggestion);
              });
            } else {
              const noResults = document.createElement('div');
              noResults.textContent = 'No results found';
              noResults.classList.add('no-results');
              searchResults.appendChild(noResults);
            }
          })
          .catch((error) => {
            console.error('Error fetching search suggestions:', error);
          });
      } else {
        searchResults.innerHTML = ''; // Clear any existing results
        searchResults.style.display = 'none'; // Hide dropdown
      }
    });

    // Handle keyboard navigation
    searchBox.addEventListener('keydown', function (event) {
      const items = searchResults.querySelectorAll('.suggestion-item');
      if (items.length > 0) {
        if (event.key === 'ArrowDown') {
          event.preventDefault(); // Prevent cursor movement
          currentIndex = (currentIndex + 1) % items.length; // Move to the next item
          highlightItem(items, currentIndex);
        } else if (event.key === 'ArrowUp') {
          event.preventDefault(); // Prevent cursor movement
          currentIndex = (currentIndex - 1 + items.length) % items.length; // Move to the previous item
          highlightItem(items, currentIndex);
        } else if (event.key === 'Enter') {
          event.preventDefault(); // Prevent form submission
          if (currentIndex >= 0 && items[currentIndex]) {
            items[currentIndex].click(); // Trigger click on the highlighted item
          }
        }
      }
    });

    // Highlight suggestion item
    function highlightItem(items, index) {
      items.forEach((item, i) => {
        if (i === index) {
          item.classList.add('highlight'); // Add highlight class
          item.scrollIntoView({ block: 'nearest' }); // Ensure visibility
          searchBox.value = item.textContent; // Update search box with the highlighted item's text
        } else {
          item.classList.remove('highlight'); // Remove highlight class
        }
      });
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', function (event) {
      if (!searchBox.contains(event.target) && !searchResults.contains(event.target)) {
        searchResults.style.display = 'none';
        searchBox.value = lastEnteredValue; // Reset to the last manually entered value
      }
    });
  });
</script>

  
<script>
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installLink = document.getElementById('installLink');
    installLink.style.display = 'block';

    installLink.addEventListener('click', (event) => {
        event.preventDefault();
        installLink.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            } else {
                console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
        });
    });
});

</script>
<script>

function switchProperty() {
    // Clear session storage (if needed)
    sessionStorage.clear();

    // Replace the current history state with the dashboard URL
    window.history.replaceState(null, '', '/dashboard/');

    // Optionally reload the page to clear any session-related data
    window.location.replace('/dashboard/');
}


    // Toggle dropdown menu
    function toggleOptions() {
      const dropdownMenu = document.getElementById('dropdownMenu');
      dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.rightOption-icon') && !event.target.closest('.dropdown-menu')) {
        document.getElementById('dropdownMenu').style.display = 'none';
      }
    });

    // Handle sidebar state and restore state on page load
    document.addEventListener('DOMContentLoaded', () => {
      const sidebarState = localStorage.getItem('sidebarState');
      if (window.innerWidth > 768 && (!sidebarState || sidebarState === 'open')) {
        document.body.classList.add('sidebar-open');
      }
    });

    // Toggle sidebar and save state to localStorage
    function toggleSidebar() {
      document.body.classList.toggle('sidebar-open');
      localStorage.setItem('sidebarState', document.body.classList.contains('sidebar-open') ? 'open' : 'closed');
    }

    // Fetch rooms for the selected property
    function fetchRooms(propertyId, propertyImage) {
      fetch(`/DisplayRooms/${propertyId}/`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        }
      })
      .then(response => response.json())
      .then(data => {
        updateRoomsOnPage(data.user_rooms);
        updateSelectedProperty(propertyId, propertyImage);
      })
      .catch(error => console.error('Error fetching rooms:', error));
    }

    // Update rooms on the page
    function updateRoomsOnPage(rooms) {
      const roomsContainer = document.querySelector('.display-room-row');
      roomsContainer.innerHTML = '';  // Clear existing rooms

      rooms.forEach(room => {
        const roomDiv = document.createElement('div');
        roomDiv.classList.add('room-box');
        roomDiv.innerHTML = `
          <div class="room-number">${room.room_number}</div>
          <div class="shareNumbers">${room.number_of_share}</div>
        `;
        roomsContainer.appendChild(roomDiv);
      });
    }

    // Update selected property in the UI
    function updateSelectedProperty(propertyId, propertyImage) {
      document.querySelectorAll('.tick-image').forEach(img => img.style.display = 'none');  // Hide all tick images
      document.getElementById('tick-' + propertyId).style.display = 'block';  // Show tick for selected property

      const selectedPropertyImage = document.getElementById('selectedPropertyImage');
      selectedPropertyImage.src = propertyImage;  // Update the image

      const propertyItem = document.getElementById('property-' + propertyId);
      const propertyName = propertyItem.querySelector('.property-name').textContent;
      document.getElementById('selectedPropertyName').textContent = propertyName;  // Update the property name
    }
  </script>


{% block extra_scripts %}

<!-- for installation perpose -->

<script>
  if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register("{% static 'installation/sw.js' %}")
          .then((registration) => {
              console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch((error) => {
              console.log('Service Worker registration failed:', error);
          });
  }

  // for download perpose

  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installButton = document.getElementById('installButton');
      installButton.style.display = 'block';

      installButton.addEventListener('click', () => {
          installButton.style.display = 'none';
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                  console.log('User accepted the install prompt');
              } else {
                  console.log('User dismissed the install prompt');
              }
              deferredPrompt = null;
          });
      });
  });
</script>
{% endblock %}

</body>
</html>
