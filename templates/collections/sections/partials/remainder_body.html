
<style>
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }

.remaining-amount-input {
    width: 80px; /* Adjust width as needed */
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    text-align: center;
}


    .error {
        border: 2px solid red;
        animation: shake 0.2s ease-in-out 0s 2;
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

    .green-button {
        background-color: green;
        color: white;
    }

    .yellow-button {
        background-color: yellow;
        color: black;
    }

    /* ✅ Scrollable Table for Desktop */
.table-container {
    width: 100%;
    overflow-x: auto; /* Enables horizontal scrolling */
    white-space: nowrap;
}



/* ✅ Table Tenant Name Cell */
.tenant-name-cell {
    display: flex;
    align-items: center;
    gap: 8px; /* Space between avatar and name */
}

/* ✅ Small Circular Avatar */
.table-avatar {
    width: 30px;
    height: 30px;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    font-size: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-transform: uppercase;
}

/* ✅ Truncated Tenant Name */
.table-tenant-name {
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px; /* Prevents long names from breaking layout */
}


/* ✅ Hide Table on Small Screens & Show Cards */
@media screen and (max-width: 768px) {
    .table-container {
        display: none; /* Hide table on mobile */
    }

/* ✅ Due Date as a Small Title */
.card-due-date {
    font-size: 12px;
    font-weight: bold;
    color: #555;
    text-transform: uppercase;
    margin-bottom: 8px;
    text-align: left;
}


    .tenant-name {
    font-size: 14px;
    font-weight: bold;
    text-align: center;
    margin-top: 5px;
    max-width: 60px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    display: inline-block; /* Ensures proper hover effect */
    position: relative; /* Required for tooltip positioning */
}


    .payment-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }


/* ✅ Payment Card Layout */
.payment-card {
    position: relative; /* Enables positioning */
    display: flex;
    flex-direction: column; /* Stack elements for mobile */
    align-items: flex-start;
    background: white;
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    border-left: 5px solid #007bff;
    font-family: Arial, sans-serif;
    width: 100%;
    position: relative;
}

/* ✅ Card Header */
.card-header {
    display: flex;
    justify-content: space-between; /* Places Rent & Amount Paid on the Right */
    align-items: center;
    width: 100%;
    margin-bottom: 8px;
    background: #f8f9fa; /* Light background for header */
    padding: 10px;
    border-radius: 8px;
}


/* ✅ Left Section: Avatar & Name */
.card-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Left Section: Circular Avatar & Truncated Name */
.card-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    cursor: pointer;

}

/* ✅ Popup Background */
.popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* ✅ Popup Box */
.popup-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 250px;
    text-align: center;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    position: relative;
}

/* ✅ Close Button */
.close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 20px;
    cursor: pointer;
}

/* ✅ Circular Avatar in Popup */
.popup-avatar {
    width: 60px;
    height: 60px;
    background-color: #007bff;
    color: white;
    font-size: 24px;
    font-weight: bold;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px auto;
}




/* ✅ Circular Avatar */
.tenant-avatar {
    width: 40px;
    height: 40px;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    font-size: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-transform: uppercase;
}

/* ✅ Truncated Tenant Name */
.tenant-name {
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px; /* Prevents overflow */
}

/* ✅ Tenant Rent (Top Right) */
.tenant-rent {
    font-size: 16px;
    font-weight: bold;
    color: #007bff;
}

/* ✅ Payment Type */
.tenant-payment-type {
    font-size: 14px;
    font-weight: bold;
    color: #333;
}

/* Right Section: Tenant Details */
.card-right {
    flex-grow: 1;
}

/* ✅ Right Section: Rent & Amount Paid */
.card-header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
}


/* ✅ Amount Paid with Label */
.tenant-amount-paid {
    font-size: 14px;
    font-weight: bold;
    color: #28a745;
}
/* Input and Button Styling */
.payment-card input {
    width: 100%;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.payment-card button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 5px;
    width: 100%;
}


    /* ✅ Mobile Input Container */
    .mobile-input-container {
        position: relative;
        width: 100%;
        margin-top: 20px;
    }

    /* ✅ Fixed Label Position Above the Input */
    .mobile-floating-label {
        position: absolute;
        top: -10px; /* Keep label fixed above input */
        left: 12px;
        font-size: 12px; /* Smaller font */
        color: #007bff;
        background: white;
        padding: 0 5px;
        transition: none; /* No movement on focus */
        pointer-events: none; /* Prevents clicking on the label */
    }

    /* ✅ Floating Input Field */
    .mobile-floating-input {
        width: 100%;
        padding: 12px 10px;
        font-size: 16px;
        border: 2px solid #007bff;
        border-radius: 5px;
        outline: none;
        background: white;
        text-align: center; /* Centered input text */
    }

    /* ✅ Prevent Any Label Movement */
    .mobile-floating-input:focus + .mobile-floating-label,
    .mobile-floating-input:not(:placeholder-shown) + .mobile-floating-label {
        top: -10px; /* Keeps label fixed above */
        font-size: 12px;
    }



}

</style>
<div id="payments" class="section">
    <h1>Remainder Page</h1>
    <table>
        <thead>
            <tr>
                <th>Tenant Name</th>
                <th>Tenant Rent</th>
                <th>Payment Type</th>
                <th>Reference Number</th>
                <th>Due Date</th>
                <th>Amount Paid</th>
                <th>Remaining Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for remainder in remainders %}
                <tr>
                    <td class="tenant-name-cell">
                        <div class="table-avatar">
                            {{ remainder.tenant.name|first|upper }}
                        </div>
                        <span class="table-tenant-name">
                            {{ remainder.tenant.name|slice:":12" }}{% if remainder.tenant.name|length > 12 %}...{% endif %}
                        </span>
                    </td>
                    <td>{{ remainder.tenant.rent|floatformat:"0" }}</td>
                    <td>{{ remainder.payment_type }}</td>
                    <td>{{ remainder.reference_number }}</td>
                    <td>{{ remainder.due_date }}</td>
                    <td>{{ remainder.amount_paid|floatformat:"0" }}</td>
                    <td>
                        <input type="number" value="{{ remainder.remaining_amount|floatformat:"0" }}" class="remaining-amount-input" id="remainingAmount{{ remainder.id }}" oninput="validateRemainingAmount({{ remainder.id }}, {{ remainder.remaining_amount|floatformat:"0" }})" style="-moz-appearance: textfield;" />
                    </td>
                    <td>
                        <button type="button" id="payButton{{ remainder.id }}" onclick="openRemainderPaymentModal('{{ remainder.id }}', '{{ remainder.tenant.id }}', '{{ remainder.tenant.name }}', '{{ remainder.amount_paid|floatformat:"0" }}', '{{ remainder.tenant.rent|floatformat:"0" }}')">Pay</button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8">No remainder records found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>



    <div class="payment-list">
        {% for remainder in remainders %}
            <div class="payment-card">
                
                <!-- ✅ Top Section: Avatar, Name, Tenant Rent & Amount Paid -->
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="tenant-avatar">
                            {{ remainder.tenant.name|first|upper }}
                        </div>
                        <p class="tenant-name">
                            {{ remainder.tenant.name|slice:":6" }}{% if remainder.tenant.name|length > 6 %}...{% endif %}
                        </p>
                    </div>
                    <div class="card-header-right">
                        <p class="tenant-rent">₹{{ remainder.tenant.rent|floatformat:"0" }}</p>
                        <p class="tenant-amount-paid">Amount Paid: ₹{{ remainder.amount_paid|floatformat:"0" }}</p>
                    </div>
                </div>
    
                <!-- ✅ Right Side: Remaining Amount & Pay Button -->
                <div class="card-right">
                    <div class="mobile-input-container">
                        <input type="number" id="mobileRemainingAmount{{ remainder.id }}" class="mobile-floating-input" value="{{ remainder.remaining_amount|floatformat:'0' }}" placeholder=" ">
                        <label for="mobileRemainingAmount{{ remainder.id }}" class="mobile-floating-label">Remaining Amount</label>
                    </div>
                    <button>Pay</button>
                </div>
            </div>
        {% endfor %}
    </div>
    
    
    
    

<!-- ✅ Popup Modal (Only Avatar & Full Name) -->
<div id="tenantPopup" class="popup">
    <div class="popup-content">
        <span class="close-btn" onclick="closeTenantPopup()">&times;</span>
        <div class="popup-avatar"></div>
        <h2 id="popupTenantName"></h2>
    </div>
</div>











    <!-- The Remainder Payment Modal -->
    <div id="remainderPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRemainderPaymentModal()">&times;</span>
            <form method="post" action="{% url 'remainder_url' selected_property.id %}" id="remainderPaymentForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="tenant_id" id="remainderIdInput">
                <input type="hidden" name="amount_paid" id="remainderAmountInput">
                <input type="hidden" name="remaining_amount" id="remainderRemainingAmountInput">
                <h2>Payment for remainder tenant <span id="remainderTenantName"></span></h2>
                <p>Initial Payment Amount: <span id="remainderTenantAmount"></span></p>
                <p>Remaining Amount: <input type="number" name="remaining_amount_display" id="remainderRemainingAmountDisplay" readonly></p>
                <p>Tenant Rent: <span id="remainderTenantRent"></span></p>
                <label for="remainderPaymentType">Payment Type:</label><br>
                <input type="radio" id="remainderPaymentCash" name="payment_type" value="cash" checked onclick="toggleRemainderPaymentReferenceInput()">
                <label for="remainderPaymentCash">Cash</label><br>
                <input type="radio" id="remainderPaymentScreenshot" name="payment_type" value="screenshot" onclick="toggleRemainderPaymentReferenceInput()">
                <label for="remainderPaymentScreenshot">Screenshot</label><br>
                <input type="radio" id="remainderPaymentOnline" name="payment_type" value="online" onclick="toggleRemainderPaymentReferenceInput()">
                <label for="remainderPaymentOnline">Online Payment</label><br>
                <p id="remainderPaymentReferenceNumberField" style="display:none;">
                    Reference Number: <input type="text" name="reference_number" id="remainderPaymentReferenceNumberInput" placeholder="Reference Number" maxlength="12" oninput="validateRemainderPaymentReferenceInput()">
                </p>
                <p id="remainderPaymentScreenshotUploadField" style="display:none;">
                    Upload Screenshot: <input type="file" name="payment_screenshot" id="remainderPaymentScreenshotInput" onchange="validateRemainderPaymentScreenshotInput()">
                </p>
                <button type="button" id="remainderPaymentPayButton" onclick="confirmRemainderPayment()">Pay</button>
                <button type="button" class="cancel" onclick="closeRemainderPaymentModal()">Cancel</button>
            </form>
        </div>
    </div>
</div>


<script>
    // ✅ Function to Open the Popup
function openTenantPopup(name) {
    document.getElementById("popupTenantName").textContent = name;
    
    // Set the first letter inside the avatar
    document.querySelector(".popup-avatar").textContent = name.charAt(0).toUpperCase();

    document.getElementById("tenantPopup").style.display = "flex";
}

// ✅ Function to Close the Popup
function closeTenantPopup() {
    document.getElementById("tenantPopup").style.display = "none";
}

</script>



<script>
    // Function to update the button state based on the remaining amount input
    function updateButtonState(remainderId, tenantRent, amountPaid) {
        var remainingAmountInput = document.getElementById("remainingAmount" + remainderId);
        var payButton = document.getElementById("payButton" + remainderId);
        var updatedAmount = parseFloat(remainingAmountInput.value);

        if (isNaN(updatedAmount) || updatedAmount === 0) {
            remainingAmountInput.classList.add("error");
            payButton.innerText = "Enter Amount";
            payButton.className = "yellow-button";
        } else if (tenantRent - (updatedAmount + amountPaid) === 0) {
            remainingAmountInput.classList.remove("error");
            payButton.innerText = "Pay";
            payButton.className = "";
        } else {
            remainingAmountInput.classList.remove("error");
            payButton.innerText = "Update";
            payButton.className = "green-button";
        }
    }

    // Function to open the payment modal with prefilled data
    function openRemainderPaymentModal(remainderId, tenantId, tenantName, amountPaid, tenantRent) {
        var updatedAmount = document.getElementById("remainingAmount" + remainderId).value;
        console.log("Opening modal with values:", { remainderId, tenantId, tenantName, amountPaid, tenantRent, updatedAmount });
        var modal = document.getElementById("remainderPaymentModal");
        document.getElementById("remainderTenantName").textContent = tenantName;
        document.getElementById("remainderTenantAmount").textContent = updatedAmount;
        document.getElementById("remainderIdInput").value = tenantId;
        document.getElementById("remainderAmountInput").value = updatedAmount;
        document.getElementById("remainderTenantRent").textContent = tenantRent;
        var remainingAmount = parseFloat(tenantRent) - (parseFloat(updatedAmount) + parseFloat(amountPaid));
        document.getElementById("remainderRemainingAmountInput").value = remainingAmount.toFixed(0);
        document.getElementById("remainderRemainingAmountDisplay").value = remainingAmount.toFixed(0);
        modal.style.display = "block";
        toggleRemainderPaymentReferenceInput();
    }

    // Function to validate and confirm the remainder payment
    function confirmRemainderPayment() {
        var modal = document.getElementById("remainderPaymentModal");
        var paymentType = modal.querySelector("[name='payment_type']:checked").value;
        var isValid = true;

        var amountPaid = document.getElementById("remainderAmountInput").value;
        var remainingAmount = document.getElementById("remainderRemainingAmountInput").value;

        if (!amountPaid || parseFloat(amountPaid) === 0) {
            highlightError(document.getElementById("remainderAmountInput"));
            isValid = false;
        }

        if (paymentType === "online") {
            var referenceInput = modal.querySelector("#remainderPaymentReferenceNumberInput");
            if (referenceInput.value.length !== 12) {
                isValid = false;
                highlightError(referenceInput);
            }
        } else if (paymentType === "screenshot") {
            var screenshotInput = modal.querySelector("#remainderPaymentScreenshotInput");
            if (screenshotInput.files.length === 0) {
                isValid = false;
                highlightError(screenshotInput);
            }
        }

        if (isValid) {
            console.log("Submitting form with values:", {
                tenant_id: document.getElementById("remainderIdInput").value,
                amount_paid: document.getElementById("remainderAmountInput").value,
                remaining_amount: document.getElementById("remainderRemainingAmountInput").value,
                payment_type: paymentType,
                reference_number: referenceInput ? referenceInput.value : null,
                payment_screenshot: screenshotInput ? screenshotInput.files : null,
            });
            document.getElementById("remainderPaymentForm").submit();
        }
    }

    // Function to highlight input errors
    function highlightError(input) {
        input.classList.add("error");
    }

    // Function to remove input errors
    function removeError(input) {
        input.classList.remove("error");
    }

    // Function to toggle the reference input field based on payment type
    function toggleRemainderPaymentReferenceInput() {
        var paymentType = document.querySelector("[name='payment_type']:checked").value;
        var referenceField = document.getElementById("remainderPaymentReferenceNumberField");
        var screenshotField = document.getElementById("remainderPaymentScreenshotUploadField");

        if (paymentType === "online") {
            referenceField.style.display = "block";
            screenshotField.style.display = "none";
        } else if (paymentType === "screenshot") {
            referenceField.style.display = "none";
            screenshotField.style.display = "block";
        } else {
            referenceField.style.display = "none";
            screenshotField.style.display = "none";
        }
    }

    // Function to validate the reference input field
    function validateRemainderPaymentReferenceInput() {
        var referenceInput = document.getElementById("remainderPaymentReferenceNumberInput").value;
        if (referenceInput.length !== 12) {
            highlightError(document.getElementById("remainderPaymentReferenceNumberInput"));
        } else {
            removeError(document.getElementById("remainderPaymentReferenceNumberInput"));
        }
    }

    // Function to validate the screenshot input field
    function validateRemainderPaymentScreenshotInput() {
        var screenshotInput = document.getElementById("remainderPaymentScreenshotInput").files.length;
        if (screenshotInput === 0) {
            highlightError(document.getElementById("remainderPaymentScreenshotInput"));
        } else {
            removeError(document.getElementById("remainderPaymentScreenshotInput"));
        }
    }

    // Function to validate remaining amount input and revert if it exceeds actual remaining amount
    function validateRemainingAmount(remainderId, actualRemainingAmount) {
        var remainingAmountInput = document.getElementById("remainingAmount" + remainderId);
        var payButton = document.getElementById("payButton" + remainderId);
        var updatedAmount = parseFloat(remainingAmountInput.value);

        if (updatedAmount > actualRemainingAmount) {
            remainingAmountInput.value = actualRemainingAmount;
            highlightError(remainingAmountInput);
            setTimeout(() => {
                removeError(remainingAmountInput);
            }, 1000);
        } else {
            removeError(remainingAmountInput);
            updateButtonState(remainderId, actualRemainingAmount, updatedAmount);
        }
    }

    // Function to revert remaining amount to the actual value if input is cleared
    document.querySelectorAll('.remaining-amount-input').forEach(input => {
        input.addEventListener('blur', function () {
            if (this.value === "") {
                var actualRemainingAmount = parseFloat(this.getAttribute('value'));
                this.value = actualRemainingAmount;
                removeError(this);
                updateButtonState(this.id.replace('remainingAmount', ''), actualRemainingAmount, 0);
            }
        });
    });
</script>
